

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Asynchronous modules &mdash; Turbo.lua 2.0.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Turbo.lua 2.0.0 documentation" href="index.html"/>
        <link rel="next" title="Turbo.lua API Versioning" href="apiref.html"/>
        <link rel="prev" title="Get Started With Turbo" href="get_started.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="index.html" class="fa fa-home"> Turbo.lua</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="get_started.html">Get Started With Turbo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="get_started.html#installing-turbo">Installing Turbo</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_started.html#hello-world">Hello World</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_started.html#request-parameters">Request parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_started.html#routes">Routes</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_started.html#serving-static-files">Serving Static Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_started.html#json-output">JSON Output</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Asynchronous modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-module">Example module</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apiref.html">Turbo.lua API Versioning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="apiref.html#preliminaries">Preliminaries</a></li>
<li class="toctree-l2"><a class="reference internal" href="apiref.html#module-version">Module Version</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="web.html">turbo.web &#8211; Core web framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="web.html#requesthandler-class">RequestHandler class</a></li>
<li class="toctree-l2"><a class="reference internal" href="web.html#httperror-class">HTTPError class</a></li>
<li class="toctree-l2"><a class="reference internal" href="web.html#staticfilehandler-class">StaticFileHandler class</a></li>
<li class="toctree-l2"><a class="reference internal" href="web.html#redirecthandler-class">RedirectHandler class</a></li>
<li class="toctree-l2"><a class="reference internal" href="web.html#application-class">Application class</a></li>
<li class="toctree-l2"><a class="reference internal" href="web.html#mustache-templating">Mustache Templating</a></li>
<li class="toctree-l2"><a class="reference internal" href="web.html#mustache-templatehelper-class">Mustache.TemplateHelper class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="async.html">turbo.async &#8211; Asynchronous clients</a><ul>
<li class="toctree-l2"><a class="reference internal" href="async.html#utilities-for-coroutines">Utilities for coroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="async.html#httpclient-class">HTTPClient class</a></li>
<li class="toctree-l2"><a class="reference internal" href="async.html#httpresponse-class">HTTPResponse class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="websocket.html">turbo.websocket &#8211; WebSocket server and client</a><ul>
<li class="toctree-l2"><a class="reference internal" href="websocket.html#websocketstream-mixin">WebSocketStream mixin</a></li>
<li class="toctree-l2"><a class="reference internal" href="websocket.html#websockethandler-class">WebSocketHandler class</a></li>
<li class="toctree-l2"><a class="reference internal" href="websocket.html#websocketclient-class">WebSocketClient class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ioloop.html">turbo.ioloop &#8211; Main I/O Loop</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ioloop.html#ioloop-class">IOLoop class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="iostream.html">turbo.iostream &#8211; High-level asynchronous streaming sockets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="iostream.html#iostream-class">IOStream class</a></li>
<li class="toctree-l2"><a class="reference internal" href="iostream.html#ssliostream-class">SSLIOStream class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="httputil.html">turbo.httputil &#8211; Utilities for the HTTP protocol</a><ul>
<li class="toctree-l2"><a class="reference internal" href="httputil.html#httpparser-class">HTTPParser class</a></li>
<li class="toctree-l2"><a class="reference internal" href="httputil.html#httpheaders-class">HTTPHeaders class</a></li>
<li class="toctree-l2"><a class="reference internal" href="httputil.html#functions">Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="httpserver.html">turbo.httpserver &#8211; Callback based HTTP Server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="httpserver.html#httpserver-class">HTTPServer class</a></li>
<li class="toctree-l2"><a class="reference internal" href="httpserver.html#httprequest-class">HTTPRequest class</a></li>
<li class="toctree-l2"><a class="reference internal" href="httpserver.html#httpconnection-class">HTTPConnection class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tcpserver.html">turbo.tcpserver &#8211; Callback based TCP socket Server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tcpserver.html#tcpserver-class">TCPServer class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="structs.html">turbo.structs &#8211; Data structures</a><ul>
<li class="toctree-l2"><a class="reference internal" href="structs.html#deque-double-ended-queue">deque, Double ended queue</a></li>
<li class="toctree-l2"><a class="reference internal" href="structs.html#buffer-low-level-mutable-buffer">buffer, Low-level mutable buffer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hash.html">turbo.hash &#8211; Cryptographic Hashes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="hash.html#sha1-class">SHA1 class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="util.html">turbo.util Common utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="util.html#table-tools">Table tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="util.html#low-level">Low level</a></li>
<li class="toctree-l2"><a class="reference internal" href="util.html#misc">Misc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sockutil.html">turbo.sockutil &#8211; Socket utilites and helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="escape.html">turbo.escape &#8211; Escaping and JSON utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="escape.html#json-conversion">JSON conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="escape.html#escaping">Escaping</a></li>
<li class="toctree-l2"><a class="reference internal" href="escape.html#string-trimming">String trimming</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="log.html">turbo.log &#8211; Command-line log helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="turbovisor.html">turbovisor &#8211; Application supervisor</a><ul>
<li class="toctree-l2"><a class="reference internal" href="turbovisor.html#options">Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="turbovisor.html#examples">Examples</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Turbo.lua</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Asynchronous modules</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/modules.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="asynchronous-modules">
<span id="modules"></span><h1>Asynchronous modules<a class="headerlink" href="#asynchronous-modules" title="Permalink to this headline">¶</a></h1>
<p>Using native modules instead of generic Lua modules are important when using sockets to communicate with e.g databases
to get the best performance, since the generic modules will block during long operations. If the operations you are
doing are relatively fast then you may get away with using a generic module. This is something you have to benchmark yourself
in your specific cases.</p>
<p>Creating modules for Turbo using the highly abstracted IOStream classes is real easy. If there is not a driver for e.g a database
etc available then please do try to make it.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>There are many ways of implementing async modules in Turbo.lua. To list the most apparent:</p>
<ul class="simple">
<li>Using callbacks</li>
<li>Using Coroutine wrappable functions</li>
<li>Using Coroutines and the CoroutineContext class</li>
</ul>
<p>Which one suits your module best is up to your. Know that at the time of writing, no functions within the Lua Coroutine namespace
is inlined by LuaJIT. Instead it fallbacks to the very fast interpreter. So if every little performance matters then callbacks
are the way to go. All of the modules in the core framework uses Coroutine wrappable functions, except the HTTPClient, which uses
coroutines and the CoroutineContext class.</p>
<p>Callback based modules is probably the flavour that most have used before. Basically you take in a callback
(and maybe a callback argument/userdata) as argument(s) for the functions of your module. This function is then called when I/O
has been completed. This means the user of your module must either split his program flow into seperate functions (seemingly in parts)
or create closures inside functions.</p>
<p>Coroutine wrappable functions means that the functions of your API strictly adhers to the convention where the last two arguments of a
functions always are a callback AND a callback argument (the argument is passed as first argument into the provided callback when it is
called on I/O completion). If, and only if these requirements are met, the users of your module may use the <tt class="docutils literal"><span class="pre">turbo.async.task</span></tt> function
to wrap the function and use the builtin Lua yield functionality. These functions then supports both callback-style and yield-style programming.</p>
<p>Coroutine directly with the CoroutineContext class does not offer a callback compatible API, and the users of the module must always yield
to the I/O loop. This has some advantages in that it creates a 100% &#8220;I don&#8217;t care about this async stuff&#8221; environment.</p>
<p>Programmatically this can be illustrated as follows:</p>
<p>&#8220;I don&#8217;t care about this async stuff&#8221; module:</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kd">local</span> <span class="n">turbo</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo&quot;</span>
 <span class="kd">local</span> <span class="n">turboredis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo-redis&quot;</span>
 <span class="kd">local</span> <span class="n">rconn</span> <span class="o">=</span> <span class="n">turboredis</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

 <span class="kd">local</span> <span class="n">ExampleHandler</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ExampleHandler&quot;</span><span class="p">,</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">)</span>
 <span class="k">function</span> <span class="nf">ExampleHandler</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
     <span class="n">self</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">The value is &quot;</span> <span class="o">..</span> <span class="n">rconn</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myvalue&quot;</span><span class="p">))</span>
 <span class="k">end</span>

 <span class="kd">local</span> <span class="n">application</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">({</span>
     <span class="p">{</span><span class="s2">&quot;</span><span class="s">^/$&quot;</span><span class="p">,</span> <span class="n">ExampleHandler</span><span class="p">}</span>
 <span class="p">})</span>
 <span class="n">application</span><span class="p">:</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
 <span class="n">turbo</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">instance</span><span class="p">():</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Callback-type module:</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kd">local</span> <span class="n">turbo</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo&quot;</span>
 <span class="kd">local</span> <span class="n">turboredis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo-redis&quot;</span>
 <span class="kd">local</span> <span class="n">rconn</span> <span class="o">=</span> <span class="n">turboredis</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

 <span class="kd">local</span> <span class="n">ExampleHandler</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ExampleHandler&quot;</span><span class="p">,</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">)</span>
 <span class="k">function</span> <span class="nf">ExampleHandler</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
     <span class="kd">local</span> <span class="n">_self</span> <span class="o">=</span> <span class="n">self</span>
     <span class="n">rconn</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myvalue&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
         <span class="n">_self</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">The value is &quot;</span> <span class="o">..</span> <span class="n">rconn</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myvalue&quot;</span><span class="p">))</span>
     <span class="k">end</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="kd">local</span> <span class="n">application</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">({</span>
     <span class="p">{</span><span class="s2">&quot;</span><span class="s">^/$&quot;</span><span class="p">,</span> <span class="n">ExampleHandler</span><span class="p">}</span>
 <span class="p">})</span>
 <span class="n">application</span><span class="p">:</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
 <span class="n">turbo</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">instance</span><span class="p">():</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Callback-type module with callback argument and no closures, probably
well known for those familiar with Python and Tornado.</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kd">local</span> <span class="n">turbo</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo&quot;</span>
 <span class="kd">local</span> <span class="n">turboredis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo-redis&quot;</span>
 <span class="kd">local</span> <span class="n">rconn</span> <span class="o">=</span> <span class="n">turboredis</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

 <span class="k">function</span> <span class="nf">ExampleHandler</span><span class="p">:</span><span class="n">_process_request</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
     <span class="n">self</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">The value is &quot;</span> <span class="o">..</span> <span class="n">data</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="kd">local</span> <span class="n">ExampleHandler</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ExampleHandler&quot;</span><span class="p">,</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">)</span>
 <span class="k">function</span> <span class="nf">ExampleHandler</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
     <span class="n">rconn</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myvalue&quot;</span><span class="p">,</span> <span class="n">ExampleHandler</span><span class="p">.</span><span class="n">_process_request</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="kd">local</span> <span class="n">application</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">({</span>
     <span class="p">{</span><span class="s2">&quot;</span><span class="s">^/$&quot;</span><span class="p">,</span> <span class="n">ExampleHandler</span><span class="p">}</span>
 <span class="p">})</span>
 <span class="n">application</span><span class="p">:</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
 <span class="n">turbo</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">instance</span><span class="p">():</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Coroutine wrappable Callback-type module:</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kd">local</span> <span class="n">turbo</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo&quot;</span>
 <span class="kd">local</span> <span class="n">turboredis</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo-redis&quot;</span>
 <span class="kd">local</span> <span class="n">task</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">task</span>
 <span class="kd">local</span> <span class="n">yield</span> <span class="o">=</span> <span class="nb">coroutine.yield</span>

 <span class="kd">local</span> <span class="n">rconn</span> <span class="o">=</span> <span class="n">turboredis</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>

 <span class="kd">local</span> <span class="n">ExampleHandler</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ExampleHandler&quot;</span><span class="p">,</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">)</span>
 <span class="k">function</span> <span class="nf">ExampleHandler</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
     <span class="n">self</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">The value is &quot;</span> <span class="o">..</span> <span class="n">yield</span><span class="p">(</span><span class="n">task</span><span class="p">(</span><span class="n">turboredis</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">rconn</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">myvalue&quot;</span><span class="p">))))</span>
 <span class="k">end</span>

 <span class="kd">local</span> <span class="n">application</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">({</span>
     <span class="p">{</span><span class="s2">&quot;</span><span class="s">^/$&quot;</span><span class="p">,</span> <span class="n">ExampleHandler</span><span class="p">}</span>
 <span class="p">})</span>
 <span class="n">application</span><span class="p">:</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
 <span class="n">turbo</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">instance</span><span class="p">():</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>The easiest to use is probably the first, where the program flow and code paths are more easily
followed. The builtin HTTPClient uses this style of API... It is probably also a good choice for
database queries etc, so you can keep your logic clean and easy to follow.</p>
<p>All callbacks added to the I/O loop are executed in its own coroutine. The callback functions can yield
execution back to the I/O loop. Lua yield&#8217;s can return a object as it return to where the coroutine where
started... This is utilized in the Turbo.lua I/O loop which will treat yields different based on what they
return as they yield. The I/O Loop supports these returns:</p>
<ul class="simple">
<li>A function, that will be called on next iteration and its results returned when resuming the coroutine thread.</li>
<li>Nil, a empty yield that will simply resume the coroutine thread on next iteration.</li>
<li>A CoroutineContext class, which acts as a reference to the I/O loop which allow the coroutine thread to be
managed manually and resumed on demand.</li>
</ul>
</div>
<div class="section" id="example-module">
<h2>Example module<a class="headerlink" href="#example-module" title="Permalink to this headline">¶</a></h2>
<p>So bearing this in mind let us create a CouchDB module.</p>
<p>We will create this one with a API that supports the business as usual programming style where the programmer does
not yield or control this flow by himself. Note that this is in no way a complete and stable module, it is only
meant to give some pointers:</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kd">local</span> <span class="n">turbo</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo&quot;</span>

 <span class="c1">-- Create a namespace to return.</span>
 <span class="kd">local</span> <span class="n">couch</span> <span class="o">=</span> <span class="p">{}</span>

 <span class="c1">-- CouchDB class, it is obviously optional if you want to use object orientation or not.</span>
 <span class="n">couch</span><span class="p">.</span><span class="n">CouchDB</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">CouchDB&quot;</span><span class="p">)</span>


 <span class="c1">-- Init function to setup connection to CouchDB and more.</span>
 <span class="k">function</span> <span class="nc">couch</span><span class="p">.</span><span class="nf">CouchDB</span><span class="p">:</span><span class="n">initialize</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ioloop</span><span class="p">)</span>
     <span class="nb">assert</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">string&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">addr argument is not a valid address.&quot;</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">ioloop</span> <span class="o">=</span> <span class="n">ioloop</span>
     <span class="kd">local</span> <span class="n">sock</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">new_nonblock_socket</span><span class="p">(</span>
         <span class="n">turbo</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span>
         <span class="n">turbo</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span>
         <span class="mi">0</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span>
         <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Could not create socket.&quot;</span><span class="p">)</span>
     <span class="k">end</span>
     <span class="n">self</span><span class="p">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span>

     <span class="n">self</span><span class="p">.</span><span class="n">iostream</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">iostream</span><span class="p">.</span><span class="n">IOStream</span><span class="p">(</span>
         <span class="n">self</span><span class="p">.</span><span class="n">sock</span><span class="p">,</span>
         <span class="n">self</span><span class="p">.</span><span class="n">io_loop</span><span class="p">,</span>
         <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>

     <span class="kd">local</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="n">addr</span><span class="p">:</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">:&quot;</span><span class="p">))</span>
     <span class="n">self</span><span class="p">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">hostname</span>
     <span class="n">self</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">false</span>
     <span class="n">self</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="kc">false</span>
     <span class="kd">local</span> <span class="n">_self</span> <span class="o">=</span> <span class="n">self</span>

     <span class="kd">local</span> <span class="n">rc</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span>
         <span class="n">self</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span>
         <span class="n">self</span><span class="p">.</span><span class="n">port</span><span class="p">,</span>
         <span class="n">turbo</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span>
         <span class="k">function</span><span class="p">()</span>
             <span class="c1">-- Set a connected flag, so that we know we can process requests.</span>
             <span class="n">_self</span><span class="p">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">true</span>
             <span class="n">turbo</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Couch Connected!&quot;</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
         <span class="k">function</span><span class="p">()</span> <span class="n">turbo</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Could not connect to CouchDB!&quot;</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">rc</span> <span class="o">~=</span> <span class="mi">0</span> <span class="k">then</span>
         <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Host not reachable. &quot;</span> <span class="o">..</span> <span class="n">msg</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">)</span>
     <span class="k">end</span>
     <span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">:</span><span class="n">set_close_callback</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
         <span class="n">_self</span><span class="p">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">false</span>
         <span class="n">turbo</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">CouchDB disconnected!&quot;</span><span class="p">)</span>
         <span class="c1">-- Add reconnect code here.</span>
     <span class="k">end</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="k">function</span> <span class="nc">couch</span><span class="p">.</span><span class="nf">CouchDB</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
     <span class="nb">assert</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">connected</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">No connection to CouchDB, can not process request.&quot;</span><span class="p">)</span>
     <span class="nb">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">busy</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Connection is busy, try again later.&quot;</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="kc">true</span>

     <span class="n">self</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">httputil</span><span class="p">.</span><span class="n">HTTPHeaders</span><span class="p">()</span>
     <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Host&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">hostname</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User-Agent&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Turbo Couch&quot;</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span><span class="n">set_method</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">GET&quot;</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span><span class="n">set_version</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">HTTP/1.1&quot;</span><span class="p">)</span>
     <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span><span class="n">set_uri</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
     <span class="kd">local</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">:</span><span class="n">stringify_as_request</span><span class="p">()</span>

     <span class="c1">-- Write request HTTP header to stream and wait for finish using the simple way with turbo.async.task wrapper</span>
     <span class="c1">-- function.</span>
     <span class="nb">coroutine.yield</span> <span class="p">(</span><span class="n">turbo</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">.</span><span class="n">write</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>

     <span class="c1">-- Wait until end of HTTP response header has been read.</span>
     <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">coroutine.yield</span> <span class="p">(</span><span class="n">turbo</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">.</span><span class="n">read_until_pattern</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s">?</span><span class="se">\n\r</span><span class="s">?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>

     <span class="c1">-- Decode response header.</span>
     <span class="kd">local</span> <span class="n">response_headers</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">httputil</span><span class="p">.</span><span class="n">HTTPParser</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">turbo</span><span class="p">.</span><span class="n">httputil</span><span class="p">.</span><span class="n">hdr_t</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">HTTP_RESPONSE&quot;</span><span class="p">])</span>

     <span class="c1">-- Read the actual body now that we know the size of body.</span>
     <span class="kd">local</span> <span class="n">body</span> <span class="o">=</span> <span class="nb">coroutine.yield</span> <span class="p">(</span><span class="n">turbo</span><span class="p">.</span><span class="n">async</span><span class="p">.</span><span class="n">task</span><span class="p">(</span>
             <span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">.</span><span class="n">read_bytes</span><span class="p">,</span>
             <span class="n">self</span><span class="p">.</span><span class="n">iostream</span><span class="p">,</span>
             <span class="nb">tonumber</span><span class="p">((</span><span class="n">response_headers</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Content-Length&quot;</span><span class="p">)))))</span>

     <span class="c1">-- Decode JSON response body and return it to caller.</span>
     <span class="kd">local</span> <span class="n">json_dec</span> <span class="o">=</span> <span class="n">turbo</span><span class="p">.</span><span class="n">escape</span><span class="p">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">json_dec</span>
 <span class="k">end</span>

 <span class="c1">--- Add more methods :)</span>

 <span class="k">return</span> <span class="n">couch</span>
</pre></div>
</td></tr></table></div>
<p>Usage from a turbo.web.RequestHandler:</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre> <span class="kd">local</span> <span class="n">turbo</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo&quot;</span>
 <span class="kd">local</span> <span class="n">couch</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">turbo-couch&quot;</span>

 <span class="c1">-- Create a instance.</span>
 <span class="kd">local</span> <span class="n">cdb</span> <span class="o">=</span> <span class="n">couch</span><span class="p">.</span><span class="n">CouchDB</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">localhost:5984&quot;</span><span class="p">)</span>

 <span class="kd">local</span> <span class="n">ExampleHandler</span> <span class="o">=</span> <span class="n">class</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ExampleHandler&quot;</span><span class="p">,</span> <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">)</span>
 <span class="k">function</span> <span class="nf">ExampleHandler</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
     <span class="c1">-- Write response directly through.</span>
     <span class="n">self</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">cdb</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/test/toms_resource&quot;</span><span class="p">))</span>
 <span class="k">end</span>

 <span class="n">turbo</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">Application</span><span class="p">({{</span><span class="s2">&quot;</span><span class="s">^/$&quot;</span><span class="p">,</span> <span class="n">ExampleHandler</span><span class="p">}}):</span><span class="n">listen</span><span class="p">(</span><span class="mi">8888</span><span class="p">)</span>
 <span class="n">turbo</span><span class="p">.</span><span class="n">ioloop</span><span class="p">.</span><span class="n">instance</span><span class="p">():</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="apiref.html" class="btn btn-neutral float-right" title="Turbo.lua API Versioning">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="get_started.html" class="btn btn-neutral" title="Get Started With Turbo"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, John Abrahamsen.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45069639-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>